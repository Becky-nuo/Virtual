#基于华为云鲲鹏弹性云服务器发布地图服务##实验拓扑>安装部署iServer应用：从华为云OBS中下载部署iServer所需RPM依赖包和docker_iserver文件，在华为鲲鹏云服务器上完成iServer的安装部署；>通过本地超图iDesktop工具，将地图数据上传到预置的华为鲲鹏云服务器上的PostgreSQL数据库中；>访问iServer应用的web后台页面，把发布服务的数据源绑定到PostgreSQL数据库；>使用iServer应用发布地图服务，实现公网对地图的访问;##实验环境准备>购买鲲鹏云服务器的、EulerOS以及依赖的数据库环境预置等;>一台操作系统为CentOS的安装PostgreSQL数据库的华为云鲲鹏弹性云服务器;>一台操作系统为EulerOS的华为云鲲鹏弹性云服务器，虚拟私有云、弹性公网IP和安全组;>应用运行环境配置：源重新配置，依赖包安装（libjpeg、libcurl等），从华为云OBS中下载RPM包等;##登录华为云账号>登录到弹性云服务器依次点击“控制台”->“服务列表”->“计算”->“弹性云服务器ECS”进入服务器列表;###登录云服务器；>弹性云服务器ECS的公网IP替换命令中的【EIP】，执行下面命令：`LANG=en_us.UTF-8 ssh root@EIP`;>接受秘钥输入“yes”，回车；>输入密码：Huawei@123（输入密码时，命令行窗口不会显示密码，输完之后直接键入回车）;###系统内源更新配置>替换云服务器系统的yum源，您需根据实际情况选择是否替换。如需替换，输入指令如下：`wget http://mirrors.myhuaweicloud.com/repo/mirrors_source.sh && sudo sh mirrors_source.sh`>安装iServer依赖libjpeg包下载libjpeg包执行指令如下：`wget http://www.ijg.org/files/jpegsrc.v8c.tar.gz`>解压压缩文件并进入解压缩路径，运行指令如下：`tar -zxf  jpegsrc.v8c.tar.gz && cd ./jpeg-8c`>配置编译安装环境和安装目录，指定安装环境为arm环境，安装目录为/usr/libjpeg：`./configure --build=arm-linux  --prefix=/usr/libjpeg`>输入以下命令开始进行编译安装，并将安装完毕的目录下的libjpeg.so.8.3.0文件拷贝到/usr/lib64系统级目录下，同时建立libjpeg的软链接：`make -j4 && make -j4 install && make clean && cp /usr/libjpeg/lib/libjpeg.so.8.3.0 /usr/lib64/ && cd /usr/lib64 && ln -s libjpeg.so.8.3.0 libjpeg.so.8`>注：由于鲲鹏云服务器是4u（4核cpu），采用“-j4”参数;>安装iServer依赖包libcurl执行指令如下：`yum install curl -y`>安装iServer依赖rpm包从华为云OBS中下载iServer安装部署所需的rpm依赖包，如“libpng、libXi、libXest”等，指令如下：`cd /root/; wget https://sandbox-experiment-resource-north-4.obs.cn-north-4.myhuaweicloud.com/postgresql-arm/dependencies-rpm.zip`>解压缩软件包并进入解压缩目录，执行命令如下：`unzip dependencies-rpm.zip && cd dependencies-rpm````安装依赖包libpng12.so.0，指令如下：rpm -ivh libpng12-1.2.57-8.eulerosv2r8.aarch64.rpm安装依赖包libXext.so.6，执行指令：rpm -ivh --force libXext-1.3.3-10.eulerosv2r8.aarch64.rpm安装依赖包libXi.so.6，指令如下：rpm -ivh libXi-1.7.9-8.eulerosv2r8.aarch64.rpm安装依赖包libXrender.so.1，指令如下：rpm -ivh --nodeps --force libXrender-0.9.10-8.eulerosv2r8.aarch64.rpm安装依赖包libXtst.so.6，指令如下：rpm -ivh libXtst-1.2.3-8.eulerosv2r8.aarch64.rpm```##地图应用服务器搭建>操作包含安装docker环境、构建基础镜像、部署由超图提供的iServer镜像，并启动服务;###安装docker>采用默认安装方式，运行指令如下：`yum install docker -y`>执行查看指令：`docker version`###构建镜像>构建Euler系统运行环境，将操作系统压缩为 tar文件，并制作成基础镜像、导入镜像仓库。基础镜像命名为： “armv8-base:v2.8”；>将以该基础镜像制作iserver docker镜像：iserver:910-armv8;>在当前纯净的Euler OS上，将系统打包为tar包，指令如下：`tar -cvpf /root/armv8-base.tar --directory=/ --exclude=proc --exclude=sys --exclude=dev --exclude=run --exclude=boot  `>执行查看/root目录指令：`ll`>> /root会看到armv8-base.tar的包;>创建基础镜像：armv8-base:v2.8，指令如下：`docker import /root/armv8-base.tar armv8-base:v2.8`;>检查创建的镜像，指令如下：`docker images`;###检查系统运行>切换到容器运行环境，运行刚创建的镜像，指令如下：`docker run -it armv8-base:v2.8 /bin/bash`>检查系统内置的OpenJDK版本信息：`java -version`>退出容器环境：`exit`>至此，iServer部署的基础镜像构建完成。###获取docker_iserver部署文件>执行以下命令，从华为云OBS中下载iServer安装部署文件：`cd /root; wget https://sandbox-experiment-resource-north-4.obs.cn-north-4.myhuaweicloud.com/postgresql-arm/docker_iserver.bat.zip`>解压缩并进入目录，指令如下：`unzip docker_iserver.bat.zip && cd docker_iserver`###创建iServer部署镜像>执行以下指令，构建iServer部署的docker镜像：`docker build -t supermap/iserver:910-armv8 ./ `>检查镜像构建：`docker images`###启动iServer服务>指令如下：`docker run --name iserver9 -e JRE_HOME=/etc/icloud/supermap_iserver_910_16722_512_linux64_FT1500a/support/jre -d -p 8090:8090 -v /home/data:/opt/iserverOPTs supermap/iserver:910-armv8`>获取iServer服务许可，指令如下：cd /root; wget https://sandbox-experiment-resourcenorth-4.obs.cnnorth-4.myhuaweicloud.com/postgresqlarm/kunpengiserver-20200525.lic9d>添加服务许可：`docker cp kunpengiserver-20200525.lic9d iserver9:/opt/SuperMap/License/ `>登录容器，指令如下：`docker exec -it iserver9 bash`>安装iServer服务依赖包，指令如下：`yum install cups -y`>退出容器环境，指令如下：`exit`>重启容器环境，指令如下：`docker restart iserver9`>检查是否启动：`docker ps`##发布地图数据>启动超图iDesktop软件，配置Postgre SQL数据库型数据源与华为云上安全组策略，并发布地图服务;###地图数据上传数据库>利用SuperMap iDesktop工具将本地数据源“world.udb”添加到Postgre SQL数据源，并保存工作空间，用于iServer发布地图服务;>重新远程登录云服务器，输入以下指令启动位于桌面data目录下的SuperMap iDesktop应用软件：`cd /home/user/Desktop/data/supermap-idesktop-java-9.1.0-12-linux64-bin-chs; ./startup.sh`>依次选择“未命名工作空间”-->选中“数据源”-->右键“打开文件型数据源”-->选择/home/user/Desktop/data/World/目录下的World.udb文件，点击“打开”;>依次选择“数据源”-->右键“新建数据库型数据源”-->选中“postgreSQL”数据库->输入连接“postgreSQL”数据库必要信息;>配置数据库连接信息：```服务器名称：预置安装数据库的弹性云服务器公网IP和端口号“5432”，数据库名称：kunpeng_test，用户名称：postgres，用户密码：123456，```>数据库连接信息配置完成后，点击“创建”，生成数据库型数据源，在左侧工作空间管理器中，显示数据源信息“IP:5432”;>在数据源列表中选择“World.udb”右键选择“复制数据源”;>在弹出的对话框中，确认目标数据源地址为Postgre SQL数据库数据源后，点击“确定”按钮;>等待大约3分钟后复制完成，在左侧工作空间管理器中的“IP:5432”下显示复制的资源;>在“IP:5432”下的资源列表中，双击“world”资源会在右侧窗口中显示世界地图画面，在地图上右键“保存地图”，重命名为“world_map”;>再次选择数据源“World.udb”右键点击“关闭”;>右键点击“未命名工作空间”选择“保存工作空间”，在弹出窗口的左侧列表选择“postgreSQL工作空间”，输入数据库相关信息：```服务器名称：预置安装数据库的弹性云服务器的公网IP和端口号“5432”，数据库名称：kunpeng_test，用户名称：postgres，用户密码：123456，工作空间名称：kunpeng，点击“确定”，保存成功后，开始使用iServer发布数据;```###开放安全组（8090）端口>依次选择“控制台”->“服务列表”->“网络”->“虚拟私有云VPC”，进入“网络控制台”，点击左侧“访问控制”->“安全组”，查看安全组列表>点击账号名命名的安全组进入，选择“入方向规则”->“添加规则”>在弹出的“添加入方向规则”表单中，填写配置参数如下：```协议端口：自定义TCP 8090，源地址：IP地址 0.0.0.0/0，描述：自行输入规则说明点击“确定”;```###iServer地图服务发布>在浏览器中输入 iServer服务访问地址，预置的弹性云服务器名称为“kunpengIserver”的服务器公网IP和端口号8090，开始创建管理员账户;>依次执行：点击“下一步”检查系统环境-->“下一步”检查许可信息-->“下一步”配置示范服务，“配置完成”出现选择进入口;>选择“服务管理器”，点击链接地址进入。输入上一步骤创建的管理员账号和密码登录，>选择“快速发布一个或一组服务”-->选择“工作空间”，并选择“下一步”，>“快速发布服务-配置数据”，配置项如下：```工作空间类型：PGSQL工作空间，服务器名称：预置的弹性云服务器名称为“ecs-postgresql”的服务器公网IP和端口号5432，工作空间名称：kunpeng，数据库名称：kunpeng_test，用户名：postgres，密码：123456，```>配置完成后“下一步”，20秒后，弹出下一个对话框配置“快速发布的服务类型”，勾选“REST-地图服务”和“REST-数据服务”，选择“下一步”;>配置“快速发布服务-数据服务是否可编辑”，勾选“允许编辑”，并“下一步”;>配置“快速发布服务-地图服务是否可编辑”，勾选“允许编辑”，并“下一步”>“快速发布服务-配置完成”，选择“完成”>在弹出的窗口中，点击“map-kunpeng2/rest”,>在弹出的页面中底部点击“maps”,>在弹出的页面底部地图列表中，选择“for openlayers3”浏览地图;>实验全部完成;