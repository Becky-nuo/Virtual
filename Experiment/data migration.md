#MySQL本地数据库迁移##准备环境>注意：创建好实验过程所需的ECS、EIP、VPC、安全组、本地数据库等资源，并在ECS、本地数据库服务器上分别安装VPNServer和VPNClient，配置好网络环境，确保数据库迁移操作可以正常进行;>登录华为云##数据库迁移###创建云数据库RDS实例>点击服务列表->”数据库”->“云数据库RDS”进入进入实例管理界面，点击“购买数据库实例”进入参数填写界面配置相关参数：```计费方式（按需计费）区域（华北-北京四）实例名称（data-transfer-rds）选择MySQL数据库5.7版本实例类型为“单机”储存类型：超高IO可用区：选资源的可用区。示例为“可用区二”时区：UTC+08:00性能规格：通用增强型 ，配置为1核2G虚拟私有云请选择预置环境时系统生成的VPC，例如：Sandbox-Voyagerxxx ;数据库端口：默认（3306）密码请设置为（Seetraum123@）注意：密码设置有误将导致实验步骤检测不成功其他参数默认即可点击“立即购买”【约等待5分钟】，待运行状态从“创建中”变为“正常”则为购买完成;```###数据库测试程序>执行测试程序，查看需要迁移的当前服务器资源消耗，模拟真实业务场景;####执行数据库压测脚本>双击图标“Xfce 终端”打开命令行界面，执行以下命令获取MySQL登录的IP地址:`ip addr | grep inet | grep "172.16" | awk '{print $2}' | awk -F '/' '{print $1}'`>使用MySQL命令登录数据库，并创建测试数据库“loadtest”，用获取到的MySQL登录ip替换命令中的【<mysql-ip>】命令如下：`mysql -u root -P 3306 -h <mysql-ip> -p -e "create database loadtest"`>说明：提示输入密码，密码为：Huawei@123。使用sysbench命令导入测试数据到“loadtest”数据库；用获取到的MySQL登录ip替换命令中的【<mysql-ip>】，命令如下：```sysbench --test=/usr/local/share/sysbench/tests/include/oltp_legacy/oltp.lua --db-driver=mysql --mysql-db=loadtest --mysql-user=root --mysql-password=Huawei@123 --mysql-port=3306 --mysql-host=<mysql-ip> --oltp-tables-count=10 --oltp-table-size=10000 --num-threads=20 prepare```>执行测试【保持命令行开启】，用获取到的MySQL登录ip替换命令中的【<mysql-ip>】，命令如下：```sysbench --test=/usr/local/share/sysbench/tests/include/oltp_legacy/insert.lua --db-driver=mysql --mysql-db=loadtest --mysql-user=root --mysql-password=Huawei@123 --mysql-port=3306 --mysql-host=<mysql-ip> --oltp-tables-count=10 --oltp-table-size=1000 --max-time=3600 --max-requests=0 --num-threads=10 --report-interval=3 --rate=20 --forced-shutdown=1 run```>运行成功会发现程序不断读写数据库，压测脚本用于模拟数据库业务持续进行数据的读写操作。####查看CPU、IO情况>执行完成数据库测试脚本后（脚本程序不断运行），新打开一个命令行窗口，观察此时CPU、IO的使用情况，方便与后面执行数据在线迁移任务时的CPU、IO使用情况做对比,执行以下命令查看CPU使用情况：`top`>查看IO情况（CTRL+C退出top命令），执行命令如下：`iostat -d vda vdb -m 1 10`>观察vda和vdb的IO变化情况(单位为：m/s)，（观察完成之后可以CTRL+C退出）###创建迁移任务>点击服务列表->”数据库”->“数据复制服务DRS”：进入“在线迁移管理”页面，单击右上角“创建迁移任务”，进入迁移任务信息页面。“场景选择”>在“迁移实例”下，填选任务信息和迁移实例信息参数：```区域：华北-北京四任务名称： data-transfer-task数据流动方向：入云源数据库引擎：MySQL目标数据库引擎：MySQL网络类型： VPN、专线网络数据库实例：选择我们创建的RDS目标库读写设置：读写迁移模式："全量+增量"点击“下一步”完成操作;```###源库及目标库信息>迁移实例创建成功后（ 迁移实例创建需要等待约4分钟，才能创建成功），在“源库及目标库”下，填写源库信息和目标库信息：```IP（在命令行执行：ip addr 查看）：ip addr端口（3306）用户名（root）密码（Huawei@123）点击“测试连接”（ 需迁移实例创建完成后才可点击）;用户名（root）密码（Seetraum123@）```>同上点击“测试连接”,“测试连接”分别测试成功，并确定与源库和目标库连通后，勾选同意协议，单击“下一步”;###设定迁移>迁移用户选择“迁移”时，对于远程数据库（RDS）中已存在的用户将不再迁移，不存在的用户（即新增用户）则自动迁移;>对于不支持迁移的用户，可以点击“查看”了解用户不能迁移的原因；>对于支持迁移的用户，可以修改HOST地址（即该用户连接数据库的IP地址），可以单独设置密码，也可以为所有可迁移用户设置统一的密码;>说明：密码需包含大小写字母加数字和特殊字符,点击“确认所有备注”后，迁移对象选择“全部迁移”，点击“下一步”;###预检查>在“预检查”页面可以进行迁移任务预校验，校验是否可以进行任务迁移;>查看检查结果，如有失败的检查项，需要修复后，单击“重新校验”按钮重新进行迁移任务的预校验;>预检查失败项处理建议请参见《数据复制服务用户指南》中的“预检查失败项修复方法”，访问地址：https://support.huaweicloud.com/usermanual-drs/drs_precheck.html待所有检查项结果均成功时，单击“下一步”;>说明：所有检查项结果均成功时，若存在告警，需要阅读并确认告警详情后才可以继续执行下一步操作;####参数迁移>业务相关参数包括字符集设置，调度相关，Timestemp默认行为，最大连接数，锁等待时间，连接等待时间等;>性能相关参数包括*_buffer_size,*_cache_size等,大部分参数可以选择不迁移，但参数往往直接影响到业务的运行和性能的表现;>常规参数和性能参数一般情况下会有几项不一致，属于正常现象。确认无误后请点击“下一步”;###任务确认>在“任务确认”页面，选择迁移任务的启动时间，单击“启动任务”，弹出页勾选协议，点击“启动任务”，提交迁移任务;>迁移任务提交后，您可以返回“在线迁移管理”页面，查看迁移任务状态;###任务管理>迁移任务启动后，会经历全量迁移和增量迁移两个阶段，对于不同阶段的迁移任务，可以进行任务管理;####全量迁移>全量迁移中的任务，单击任务名称，在 “迁移进度”页签下，查看全量迁移完成剩余时间，了解全量迁移的进度;>当全量迁移进度显示为100%，表示全量迁移已经完成;####增量迁移>全量迁移完成后，开始进行增量迁移,对于增量迁移中的任务，单击任务名称，在“迁移进度”页签下，查看增量迁移同步时延，当时延为0s时（由于后台一直持续对数据库进行读写操作测试，所以增量迁移有一定延迟），说明源数据库和目标数据库的数据是实时同步的;####迁移对比>在增量迁移阶段，可以体验迁移对比模块，迁移对比分为：对象级对比（无需对比）、数据级对比和用户对比;>数据级对比需要手动创建对比任务，分为行数对比和内容对比，点击“迁移对比”，然后选择“数据级对比”，进入创建对比页面，点击“创建对比任务”（如果“创建对比”按钮是灰色的，可以点击右侧刷新按钮），进入创建对比任务页面，对比类型选择“行数对比”，对比时间选择“立即启动”，勾选loadtest数据库，点击蓝色的“>>”，再点击页面中的“是”创建对比任务；>说明：该对比主要是对比所选数据库表的行数是否一致（本地与RDS；由于本地测试业务不断读写数据库，对比详情有可能出现不一致情况，这属于正常现象）；>以同样的方式创建内容对比任务，对比类型选择“内容对比”，计算资源选择“DRS侧计算”，对比时间选择“立即启动”，然后随机选择一张数据表，点击“>>”，再点击”是”创建内容比对任务;>说明：该对比针对所选表的内容是否一致（RDS与本地；由于本地测试业务不断读写数据库，对比详情有可能出现不一致情况，这属于正常现象）,考虑到全选数据量太大，所需时间太长，建议实验随机选择一张表对比内容;>等待对比完成，点击“查看对比报表”，可以了解对比详情;>点击“用户对比”，可以看到源数据库与目标数据库的用户信息列表，两个数据库用户信息是一致的;####增量迁移CPU、IO资源使用情况>查看CPU使用率:`top`>观察vda,vdb的IO变化情况(单位为：m/s): `iostat -d vda vdb -m 1 10`>查看的CPU、IO情况对比可知，增量迁移对本地数据库服务器的影响很小;##业务割接###中断业务>点击当前系统底部，切换至执行压测命令行界面，键入Ctrl + C结束压测脚本，即中断本地数据库业务:`ip addr | grep inet | grep "172.16" | awk '{print $2}' | awk -F '/' '{print $1}'`>通过DRS迁移任务监控页面进行观察同步时延，当数据同步时延为0并稳定保持一段时间（即数据库读写业务中断，并确保源数据库与目标数据库数据确保保持一致，迁移完成）;>可以通过迁移对比功能，观察源数据库和目标数据库对比情况,最后一次确认数据完全一致，即全部数据迁移至RDS;###割接业务>打开RDS列表，找到名称为data-transfer-rds的RDS，复制它的IP地址;>打开命令行窗口。用RDS的IP地址替换下面命令中的"<host>"，并执行命令：```sysbench --test=/usr/local/share/sysbench/tests/include/oltp_legacy/insert.lua --db-driver=mysql --mysql-db=loadtest --mysql-user=root --mysql-password=Seetraum123@ --mysql-port=3306 --mysql-host=<host> --oltp-tables-count=10 --oltp-table-size=1000 --max-time=3600 --max-requests=0  --num-threads=20 --report-interval=3 --rate=20 --forced-shutdown=1 run```>运行成功之后，程序将会不断读写RDS数据库，业务系统指向华为云的RDS数据库，此时意味着业务对外恢复正常（业务在华为云RDS上也可用，说明迁移成功），迁移迁移完成且业务割接成功;>说明：执行命令时若提示输入密码，输入括号中密码（Huawei@123）即可;###结束实验>退出当前命令行运行程序（快捷键：Ctrl + C），切换至DRS服务列表页，点击“结束”，结束DRS迁移任务（约等待2分钟）完成实验;